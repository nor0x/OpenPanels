@page "/"
@using System.Text.Json;
@inject IJSRuntime _js;
@inject HttpClient _http

<PageTitle>Home</PageTitle>
<h1>OpenPanels</h1>
<p>
	not much to see here, just a slowly loading list of publicly available images from the <a href="https://panels.art"
		target="_blank">https://panels.art</a> server. click on an image to download it 😘
</p>
<div class="img-container">
	@if (_urls is not null)
	{

		<Virtualize Items="_urls" Context="url">
			<ItemContent>
				<a href="@url" download>
					<img style="background-image: url('@url'), url('img/3-dots-rotate.svg');" />
				</a>
			</ItemContent>
		</Virtualize>
	}
</div>
@code
{
	List<string> _urls;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			var json = await _http.GetStringAsync("data/all.json");
			var doc = JsonDocument.Parse(json);
			_urls = new List<string>();
			ExtractUrls(doc.RootElement, _urls);

			_urls = _urls.OrderBy(x => Random.Shared.Next()).ToList();

			StateHasChanged();
		}

	}

	void ExtractUrls(JsonElement element, List<string> urls)
	{
		if (element.ValueKind == JsonValueKind.Object)
		{
			foreach (var property in element.EnumerateObject())
			{
				if (property.Name == "url")
				{
					urls.Add(property.Value.GetString());
				}
				else
				{
					ExtractUrls(property.Value, urls);
				}
			}
		}
		else if (element.ValueKind == JsonValueKind.Array)
		{
			foreach (var item in element.EnumerateArray())
			{
				ExtractUrls(item, urls);
			}
		}
	}
}